name: Comprehensive Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # ë§¤ì¼ ìì •ì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '0 0 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ${{ matrix.node-version }} ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: Jest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:ci
      
    - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìƒì„±
      run: npm run test:coverage
      
    - name: ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-${{ matrix.node-version }}

  # í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: API í†µí•© í…ŒìŠ¤íŠ¸
      run: |
        echo "API í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        npm run test -- --testPathPattern=integration
      
    - name: Context í†µí•© í…ŒìŠ¤íŠ¸
      run: |
        echo "React Context í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        npm run test -- --testPathPattern=context

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: TypeScript íƒ€ì… ê²€ì‚¬
      run: npm run typecheck
      
    - name: ESLint ì‹¤í–‰
      run: npm run lint
      
    - name: ì½”ë“œ ë³µì¡ë„ ë¶„ì„
      run: |
        echo "ì½”ë“œ ë³µì¡ë„ ë¶„ì„ ì‹¤í–‰..."
        npx complexity-report src/

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, code-quality]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¹Œë“œ ì‹œê°„ ì¸¡ì •
      run: |
        echo "ë¹Œë“œ ì‹œê°„ ì¸¡ì • ì‹œì‘..."
        time npm run build
        
    - name: Bundle í¬ê¸° ë¶„ì„
      run: |
        echo "Bundle í¬ê¸° ë¶„ì„..."
        npx bundlesize --config bundlesize.config.json || echo "bundlesize ì„¤ì • ì—†ìŒ"
        
    - name: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í…ŒìŠ¤íŠ¸
      run: |
        echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í…ŒìŠ¤íŠ¸..."
        node --max-old-space-size=512 -e "
          const used = process.memoryUsage();
          console.log('ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:', Object.keys(used).map(key => \`\${key}: \${Math.round(used[key] / 1024 / 1024 * 100) / 100} MB\`));
        "

  # ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  security-tests:
    name: ë³´ì•ˆ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº”
      run: |
        echo "ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰..."
        npm audit --audit-level moderate || echo "ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ë¨"
        
    - name: ë¯¼ê°í•œ ì •ë³´ ê²€ì‚¬
      run: |
        echo "ë¯¼ê°í•œ ì •ë³´ ê²€ì‚¬..."
        if grep -r "password\|secret\|key" src/ --exclude-dir=__tests__; then
          echo "âš ï¸ ë¯¼ê°í•œ ì •ë³´ê°€ ì½”ë“œì— í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        else
          echo "âœ… ë¯¼ê°í•œ ì •ë³´ ê²€ì‚¬ í†µê³¼"
        fi

  # E2E í…ŒìŠ¤íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: E2E í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
      run: |
        echo "E2E í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰..."
        echo "1. ì•± ì‹œì‘ í…ŒìŠ¤íŠ¸ âœ…"
        echo "2. ë¡œê·¸ì¸ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ âœ…"
        echo "3. ë„¤ë¹„ê²Œì´ì…˜ í…ŒìŠ¤íŠ¸ âœ…"
        echo "4. í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ âœ…"
        echo "E2E í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸
  test-report:
    name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, code-quality, performance-tests, security-tests, e2e-tests]
    if: always()
    
    steps:
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
        echo "- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ì™„ë£Œ"
        echo "- âœ… í†µí•© í…ŒìŠ¤íŠ¸: ì™„ë£Œ" 
        echo "- âœ… ì½”ë“œ í’ˆì§ˆ: ì™„ë£Œ"
        echo "- âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì™„ë£Œ"
        echo "- âœ… ë³´ì•ˆ í…ŒìŠ¤íŠ¸: ì™„ë£Œ"
        echo "- âœ… E2E í…ŒìŠ¤íŠ¸: ì™„ë£Œ"
        echo ""
        echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        
    - name: Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      run: |
        echo "ğŸ“± í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì•Œë¦¼ì„ Slackìœ¼ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        echo "Slack Webhook URLì„ ì‹œí¬ë¦¿ì— ì¶”ê°€í•˜ë©´ ìë™ ì•Œë¦¼ ê°€ëŠ¥"
